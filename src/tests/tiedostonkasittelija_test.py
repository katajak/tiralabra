import os
import unittest
from tempfile import gettempdir
from repositories.tiedostonkasittelija import TiedostonKasittelija
from entities.avaimenpera import Avaimenpera
from entities.postilaatikko import Postilaatikko


class TestKeychain(unittest.TestCase):
    def setUp(self):
        self.tiedostonkasittelija = TiedostonKasittelija()
        self.avaimenpera = Avaimenpera(self.tiedostonkasittelija)
        self.postilaatikko = Postilaatikko(self.tiedostonkasittelija)
        os.chdir(gettempdir())
        with open(f"{gettempdir()+os.sep}asd.priv", "w", encoding="utf-8") as tiedosto:
            tiedosto.write("155302824069287835931228452073974485274966447295390557256488137232285617269050285885610079748411717581562732293757457276021553657214123164594044513833084318571728455601434384083861334019411739007725382157635130316416501591271150733579182063093725285749384453642851848969468073580700567053997744125787772352521;2351265898887889241303674221382310168311115814726944196578419765398529011114364664165107771442622976339667667599564781005593912444576888474915471851404453026705713804856629760272371457146481585724301337795985015427573069674487371274009423441696908683687264583642681811014059452125190720985543948125133740393")
        with open(f"{gettempdir()+os.sep}asd.pub", "w", encoding="utf-8") as tiedosto:
            tiedosto.write("155302824069287835931228452073974485274966447295390557256488137232285617269050285885610079748411717581562732293757457276021553657214123164594044513833084318571728455601434384083861334019411739007725382157635130316416501591271150733579182063093725285749384453642851848969468073580700567053997744125787772352521;65537")
        with open(f"{gettempdir()+os.sep}parempi_avain.priv", "w", encoding="utf-8") as tiedosto:
            tiedosto.write("18320776359946540834135103696870537795915053009720640775791671238093903172753955538044452189477674315171018318593665266537044347867692148954177046548710525248664162905941227498680542779183213685890505384665320142497992071873279506120418381973159477620583201448504700051654112366426733901317566292803613459313851461399302556726072178131726742770616541253302961522624091514371706953943714413972329375568696919979974129252516227065177265956436045339585902518841016068139093198362765947711797189217513367667290712262817814748298280463276548157129898712790745072481841387425769586248727784248342565201684578949064824230431;5257750000425325236254528439366175974877860094402029566673630966416987821736673875208509037333050010219212239438937643362203489550872849497690798960711469229242650349191183709891872508520040328428652902555584497918767030651275477228326425197234897158672640689129444414170782083216412274226479497612804399694366766796642658792562353242217245876878611046418474199577618662120908873926175828011165897947682108375640180774135148636217267726503950404925001567182569363377233818195158338269123798062006785944717052564246830670643738183334323762571221332796311280185499718114238563302324157519925330829117638894573712932801")
        with open(f"{gettempdir()+os.sep}parempi_avain.pub", "w", encoding="utf-8") as tiedosto:
            tiedosto.write("18320776359946540834135103696870537795915053009720640775791671238093903172753955538044452189477674315171018318593665266537044347867692148954177046548710525248664162905941227498680542779183213685890505384665320142497992071873279506120418381973159477620583201448504700051654112366426733901317566292803613459313851461399302556726072178131726742770616541253302961522624091514371706953943714413972329375568696919979974129252516227065177265956436045339585902518841016068139093198362765947711797189217513367667290712262817814748298280463276548157129898712790745072481841387425769586248727784248342565201684578949064824230431;65537")
        with open(f"{gettempdir()+os.sep}paras.priv", "w", encoding="utf-8") as tiedosto:
            tiedosto.write("8254879864230843395279788893852085200821538268841738513100013912470066377502923097455429740353428605407752263910593018539625610700995152145931732901492526404244041422282963123155837743069613004033957886355376652201597405562245257152562249058067324222896054588255685775350616585224049874040999831370194545538720659558651150507969562930402155503458665028775963842942323056131229909600113574733950670188956439125297349423987728598143890599382187053587851853323606604387862955037932867448783398722596473273657640334061611573435633209139056424802628846126441312008582536229121809692329151074052055307492540517194432514479101573909994254787191268036049527217916155005511580545242600902595517049484990544060911761884005134040318175220986938937517980226110898343719370750287318560914022740023480745173928631453021800680464698382316553881544348160430703319514124166484334733364960764753251822777900096018559153287827144903800912987016838345374716135657134746687010626046641267190498415825385045476793972665450369281966636509287081407057946099935276596481531821105440304222074548984184387392311816883716775449566704461164946670557851778285162248101861586691811393600166804387116274819127122014323109568695154153419070640947381940303595964927;86008012786043927833288308126483241191402928339321306254916451773781380361804466510711241095940707784293760331928782206887829590007622000655818620772527683288798281141679000451575616911963736712409594225139941671803572970455668346516846805089496079418763791568334286030820951395555010487576931883576420070779708516338846157211832754336882552597947598615782239713278243742643211569117865520456627288819431596137406453835435769276885626403580726303587869048697214952818190555946541541260828703802121323329252565849953518918996875194782372737070587054081485917113393072947881996199278097233601554833648520425982244156657790750408193671096492211859205782033852022763899279250904410951703685407817185995264066651114311732576172601411918521298665365513624631697088155865798420969096653209305721565772387739823615575037261610530448406259364978099421417483665800864195642591836780443408948471892542451265300507815251332377428679750163766020575995843815884927888293237019641567184185989208862366136077525081237999604066888150491772603930124451778035734718956666162784972595600117226651388915169322154841018515085181338061570852297109970889292358255103281456818235397848012891614747481414816098201801199452805636475113463029890407963841309")
        with open(f"{gettempdir()+os.sep}paras.pub", "w", encoding="utf-8") as tiedosto:
            tiedosto.write("8254879864230843395279788893852085200821538268841738513100013912470066377502923097455429740353428605407752263910593018539625610700995152145931732901492526404244041422282963123155837743069613004033957886355376652201597405562245257152562249058067324222896054588255685775350616585224049874040999831370194545538720659558651150507969562930402155503458665028775963842942323056131229909600113574733950670188956439125297349423987728598143890599382187053587851853323606604387862955037932867448783398722596473273657640334061611573435633209139056424802628846126441312008582536229121809692329151074052055307492540517194432514479101573909994254787191268036049527217916155005511580545242600902595517049484990544060911761884005134040318175220986938937517980226110898343719370750287318560914022740023480745173928631453021800680464698382316553881544348160430703319514124166484334733364960764753251822777900096018559153287827144903800912987016838345374716135657134746687010626046641267190498415825385045476793972665450369281966636509287081407057946099935276596481531821105440304222074548984184387392311816883716775449566704461164946670557851778285162248101861586691811393600166804387116274819127122014323109568695154153419070640947381940303595964927;65537")
        with open(f"{gettempdir()+os.sep}viesti.msg", "w", encoding="utf-8") as tiedosto:
            tiedosto.write("30901294193478390965942019302439504295738741955007988096976277805663569563654734156403803464660827644648252276157087580725987822700785678480718407796412041073669744549414585656328187610637893144703808444447192412874957139239952803092196823544625268431971183231715912221098375804365514187641828765056789709760")
        with open(f"{gettempdir()+os.sep}toinen.msg", "w", encoding="utf-8") as tiedosto:
            tiedosto.write("7348383185304610385948599932843171375926466015949470479010602307760338417336782746190912282062252262757648682558224474809334523769791622607442695966753079174961103957738485096719996599402242882026109730971768071549034851772809417534945930722530301478044683148309489080903619235477982831262487077292023555572276462819089275386783024251104095890995957447478727477262508439077865925521293785336356129287706068022782123965220798752109085023330463059509685137724521844300777232941397008698020691407158039928958899858865214264640335687487787622810799078916056550249374159683200169527959038442593088846718695516991800426431")

    def tearDown(self):
        os.remove(f"{gettempdir()+os.sep}asd.priv")
        os.remove(f"{gettempdir()+os.sep}asd.pub")
        os.remove(f"{gettempdir()+os.sep}parempi_avain.priv")
        os.remove(f"{gettempdir()+os.sep}parempi_avain.pub")
        os.remove(f"{gettempdir()+os.sep}paras.priv")
        os.remove(f"{gettempdir()+os.sep}paras.pub")
        os.remove(f"{gettempdir()+os.sep}viesti.msg")
        os.remove(f"{gettempdir()+os.sep}toinen.msg")

    def test_avaimet_tiedostoista(self):
        self.avaimenpera.lisaa_avaimet_tiedostoista()
        self.assertEqual(self.avaimenpera.avainten_maara(), 6)
        avaimet = []
        for avain in self.avaimenpera.avaimet():
            avaimet.append(avain)
        self.assertEqual(str(avaimet[0]), "asd, yksityinen, 1024 bitti채")
        self.assertEqual(str(avaimet[1]), "asd, julkinen, 1024 bitti채")
        self.assertEqual(str(avaimet[2]), "paras, yksityinen, 4096 bitti채")
        self.assertEqual(str(avaimet[3]), "paras, julkinen, 4096 bitti채")
        self.assertEqual(str(avaimet[4]), "parempi_avain, yksityinen, 2048 bitti채")
        self.assertEqual(str(avaimet[5]), "parempi_avain, julkinen, 2048 bitti채")

    def test_viestit_tiedostoista(self):
        self.postilaatikko.lisaa_viestit_tiedostoista()
        self.assertEqual(self.postilaatikko.viestien_maara(), 2)
        viestit = []
        for viesti in self.postilaatikko.viestit():
            viestit.append(viesti)
        self.assertEqual(viestit[0].viesti, 7348383185304610385948599932843171375926466015949470479010602307760338417336782746190912282062252262757648682558224474809334523769791622607442695966753079174961103957738485096719996599402242882026109730971768071549034851772809417534945930722530301478044683148309489080903619235477982831262487077292023555572276462819089275386783024251104095890995957447478727477262508439077865925521293785336356129287706068022782123965220798752109085023330463059509685137724521844300777232941397008698020691407158039928958899858865214264640335687487787622810799078916056550249374159683200169527959038442593088846718695516991800426431)
        self.assertEqual(viestit[0].tiedoston_nimi, "toinen.msg")
        self.assertEqual(viestit[1].viesti, 30901294193478390965942019302439504295738741955007988096976277805663569563654734156403803464660827644648252276157087580725987822700785678480718407796412041073669744549414585656328187610637893144703808444447192412874957139239952803092196823544625268431971183231715912221098375804365514187641828765056789709760)
        self.assertEqual(viestit[1].tiedoston_nimi, "viesti.msg")
